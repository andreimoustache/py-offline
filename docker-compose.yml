version: '3'
services:
  pyoff_main:
    build: .
    entrypoint: ["python", "./py-offline.py"]
    depends_on:
      - q
    restart: on-failure
    env_file: .env
  writer:
    build: .
    entrypoint: ["python", "./pyoffline_writer.py"]
    depends_on:
      - q
    restart: on-failure
    env_file: .env
  parser:
    build: .
    entrypoint: ["python", "./pyoffline_parser.py"]
    depends_on:
      - q
    restart: on-failure
    env_file: .env
  q:
    image: rabbitmq:3.8-alpine
    volumes:
      - ./config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./config/definitions.json:/etc/rabbitmq/definitions.json
    ports:
      - "15672:15672"
      - "5672:5672"
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "5672" ]
      interval: 5s
      timeout: 15s
      retries: 1
